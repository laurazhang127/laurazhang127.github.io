<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    	<script type="text/javascript" src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>
		<style = type= "text/css">
			div.button{
				position: absolute;
				padding-left: 30px;
			}
			div.title{
				padding-left: 30px;
				font-size: 2.0em;
				text-align:left;
				font-weight: bold;
			}
			div.backgroudstory{
				border-top-width: 10px;
				width:750px;
				text-align: left;
				padding-left: 30px;
			}
		</style>
		<div class = "title">
			<p>
			Who Survived Titanic?
			</p>
		</div>
		<div class = "backgroudstory">
			<p>
			During the great tragedy of Titanic, only one third of the passengers managed to survive. We know that there are a couple of factors that determine who had the previlidge to get on lifeboat first, but I would say social class and gender plays a large part in it. This bar chart displays how survivors and deceased ones are distributed among different social classes and genders. Now let's take a look!
			</p>
		</div>
		<div class = "button">
			<button id = "Overview">Overview</button>
			<button id = "Pclass">Survivorship Percentage by PClass</button>
			<button id = "Female" onclick="display_gender">Display Female Percentage</button>	
		</div>
		<script type="text/javascript">
			function draw(data){
				"use strict";
				var margin = 30,
					w = 900,
					h = 520;

			/* Add Header and Construct svg */

				var svg = d3.select('body')
					.append('svg')
					.attr('width', w + margin)
					.attr('height', h + margin)

			/* Group data by Pclass and flatten the dataset */

				var female_live = 0
				var female_decease = 0
				var male_live = 0
				var male_decease = 0

				function counts(leaves){
					leaves.forEach(function(d){
						if (d['Survived']== "0"  && d['Sex']=="female"){
							female_decease++;
						}else if(d['Survived']== "0"  && d['Sex']=="male"){
							male_decease++;
						}else if(d['Survived']=="1" && d['Sex']=="female"){
							female_live++;
						}else if(d['Survived']=="1" && d['Sex']=="male"){
							male_live++;
						};
					});
					return {
						"live": female_live+male_live,
						"decease": female_decease+male_decease,
						"male_live": male_live,
						"male_decease": male_decease,
						"female_live": female_live,
						"female_decease": female_decease
					};
				}

				var nested_data = d3.nest()
					.key(function(d){
						return d['Pclass'];
						})
					.rollup(counts)
					.entries(data)

				/* Set height scale and add x labels */

				var y_scale = d3.scale.linear()
					.range([margin, h])
					.domain([0, 600])

				d3.select("svg")
					.selectAll("text")
					.data(["Passenger Class1", "Passenger Class2", "Passenger Class3"])
					.enter()
					.append("text")
					.attr("x", function(d, i){
						return (3*i+2)*80 ;
					})
					.attr("y", margin + h -5)
					.style("text-anchor", "middle")
					.text(function(d){return d;})

				/* Create bars, append rectangles and texts for people counts in different passenger class*/

				var bar = svg.selectAll("g")
						.data(nested_data)
						.enter()

				bar.append("g")
					.each(function(d){
						d3.select(this).append("rect")
							.attr("x", function(d){
								return (3* d.key - 2) * 80;})
							.attr("width", 80)
							.attr("y", function(d){
								return h - y_scale(d.values['live']);
								})
							.attr("height", function(d){
								return y_scale(d.values['live']);
							})
							.attr("fill", "#84b66f")
							.attr("opacity", 0.8)
								
						d3.select(this).append("rect")
							.attr("x", function(d){
								return (3* d.key - 1) * 80;
							})
							.attr("width", 80)
							.attr("y", function(d){
								return h - y_scale(d.values['decease']);
								})
							.attr("height", function(d){
								return y_scale(d.values['decease']);
								})
							.attr("fill", "#678ca5")
							.attr("opacity", 0.8)
						})

				bar.append("g")
					.each(function(d){
					   	d3.select(this).append("text")
					   		.attr("x", function(d){
								return 3 * d.key * 80 - 120;})
					   		.attr("y", function(d){
								return (h + 20 - y_scale(d.values['live']));})
							.text(function(d){
								return d.values['live'];})
							.style("text-anchor", "middle")
							.attr("font-size", "15px")
							.attr("fill", "black")
						d3.select(this).append("text")
							.attr("x", function(d){
								return 3* d.key * 80 - 40;
								})
							.attr("y", function(d){
								return (h + 20 - y_scale(d.values['decease']));
								})
							.text(function(d){return d.values['decease'];})
							.style("text-anchor", "middle")
							.attr("font-size", "15px")
							.attr("fill", "black")
					   	});

				/* add legend */

				var legend = svg.append("g")
					.attr("class", "legend")
					.selectAll("g")
					.data(["Survived", "Deceased"])
					.enter().append("g")

				legend.append("rect")
					.attr("x", margin)
					.attr("y", function(d, i){
						return (i+2)*20;
						})
					.attr("width", 12)
					.attr("height", 12)
					.style("fill", function(d){
						if (d == "Survived"){
							return "#84b66f";
						}else{
							return "#678ca5";
							}
						})

				legend.append("text")
					.attr("x", margin + 15)
					.attr("y", function(d, i){
						return i*20 + 52;
						})
					.text(function(d){
						return d;
						})
			
				/* Define function to display female percentage */
				var format = d3.format(".0%")
				function display_gender(){
					svg.selectAll(".percentage").remove()
					bar.append("g")
						.each(function(d){
							var subelement = d3.select(this)
							subelement.append("line")
							  .attr("class", "percentage")
							  .attr("x1", function(d){
								return (3* d.key - 2) * 80;})
							  .attr("x2", function(d){
								return (3* d.key - 1) * 80;})
							  .attr("y1", function(d){
						  		return h - y_scale(d.values["female_live"]);
							  })
							  .attr("y2", function(d){
						  		return h - y_scale(d.values["female_live"]);
							  })
						  	  .attr("stroke", "black")
						 	  .attr("stroke-width", 1)
						 	  .style("stroke-dasharray","5,5")

						 	subelement.append("text")
						 		.attr("class", "percentage")
						 		.attr("x", function(d){
									return (3* d.key - 1.5) * 80;})
								.attr("y", function(d){
						  			return h + 15 - y_scale(d.values["female_live"]);
							  		})
								.attr("text-anchor", "middle")
								.text(function(d){
									var femaper = d.values["female_live"]/d.values["live"]
									return format(femaper);
									})
								.attr("fill", "black")
								.style("font-size", "15px")

							var subelement2 = d3.select(this)
							subelement2.append("line")
							  .attr("class", "percentage")
							  .attr("x1", function(d){
								return (3* d.key - 1) * 80;})
							  .attr("x2", function(d){
								return 3* d.key * 80;})
							  .attr("y1", function(d){
							  	return h - y_scale(d.values["female_decease"]);
							  })
							  .attr("y2", function(d){
							  	return h - y_scale(d.values["female_decease"]);
							  })
							  .attr("stroke", "black")
						 	  .attr("stroke-width", 1)
						 	  .style("stroke-dasharray","5,5")
						 	subelement2.append("text")
						 		.attr("class", "percentage")
						 		.attr("x", function(d){
									return (3* d.key - 0.5) * 80;})
								.attr("y", function(d){
						  			return h + 15 - y_scale(d.values["female_decease"]);
							  		})
								.attr("text-anchor", "middle")
								.text(function(d){
									var femaper = d.values["female_decease"]/d.values["decease"]
									return format(femaper);
									})
								.attr("fill", "black")
								.style("font-size", "15px")
						})
					  }
				function display_percentage(){
					svg.selectAll(".percentage").remove()
					bar.append("g")
						.each(function(d){
							d3.select(this).append("text")
								.attr("class", "percentage")
								.attr("x", function(d){
								return 3* d.key * 80 -120;})
								.attr("y", function(d){
									return h + 40 - y_scale(d.values['live']);})
								.text(function(d){
									var perclass = d.values['live']/(d.values['live']+d.values['decease'])
									return format(perclass) + " of Pclass" + d.key;
								})
								.style("font-size", "13px")
								.attr("text-anchor", "middle")
							d3.select(this).append("text")
								.attr("class", "percentage")
								.attr("x", function(d){
								return 3* d.key * 80 - 40;})
								.attr("y", function(d){
									return h + 40 - y_scale(d.values['decease']);})
								.text(function(d){
									var perclass = d.values['decease']/(d.values['live']+d.values['decease'])
									return format(perclass) + " of Pclass" + d.key;
								})
								.style("font-size", "13px")
								.attr("text-anchor", "middle")
						})
				}
				d3.select("#Female").on("click", display_gender)
				d3.select("#Pclass").on("click", display_percentage)
				d3.select("#Overview").on("click", function(){
					svg.selectAll(".percentage").remove();
				})
				};
			</script>
		</head>
<body>
	<script type="text/javascript">
	d3.csv('titanic_data.csv', draw);
	</script>
</body>
</html>